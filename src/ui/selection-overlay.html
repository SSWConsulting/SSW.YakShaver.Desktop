<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Region</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.2);
        cursor: crosshair;
        user-select: none;
        position: relative;
      }

      .selection {
        position: absolute;
        border: 2px solid #cc4141;
        background: rgba(255, 59, 48, 0.08);
        box-shadow: 0 0 0 1px rgba(255, 59, 48, 0.4),
          0 0 12px rgba(255, 59, 48, 0.4), 0 0 0 9999px rgba(0, 0, 0, 0.55);
        pointer-events: none;
      }

      .hud {
        position: fixed;
        top: 12px;
        right: 12px;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 10px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 13px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .hud strong {
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="hud">
      <span><strong>Click + drag</strong> to select</span>
      <span>|</span>
      <span>Esc to cancel</span>
    </div>
    <div id="selection" class="selection" style="display: none"></div>

    <script>
      const selectionEl = document.getElementById("selection");
      let startX = 0;
      let startY = 0;
      let isDragging = false;

      const params = new URLSearchParams(window.location.search);
      const displayId = params.get("displayId") || undefined;
      const mode = params.get("mode") || "select";
      const presetX = Number(params.get("x"));
      const presetY = Number(params.get("y"));
      const presetW = Number(params.get("width"));
      const presetH = Number(params.get("height"));

      function updateSelection(x1, y1, x2, y2) {
        const left = Math.min(x1, x2);
        const top = Math.min(y1, y2);
        const width = Math.abs(x1 - x2);
        const height = Math.abs(y1 - y2);
        selectionEl.style.left = `${left}px`;
        selectionEl.style.top = `${top}px`;
        selectionEl.style.width = `${width}px`;
        selectionEl.style.height = `${height}px`;
        selectionEl.style.display = "block";
      }

      function finishSelection(x1, y1, x2, y2) {
        const left = Math.min(x1, x2);
        const top = Math.min(y1, y2);
        const width = Math.abs(x1 - x2);
        const height = Math.abs(y1 - y2);
        if (width < 2 || height < 2) {
          window.electronAPI.selectionOverlay.cancel();
          return;
        }
        window.electronAPI.selectionOverlay.complete({
          x: left,
          y: top,
          width,
          height,
          displayId,
        });
      }

      if (mode === "highlight") {
        if (
          Number.isFinite(presetX) &&
          Number.isFinite(presetY) &&
          Number.isFinite(presetW) &&
          Number.isFinite(presetH)
        ) {
          updateSelection(
            presetX,
            presetY,
            presetX + presetW,
            presetY + presetH
          );
          selectionEl.style.pointerEvents = "none";
          document.body.style.cursor = "default";
          const hud = document.querySelector(".hud");
          if (hud) hud.style.display = "none";
        }
      } else {
        window.addEventListener("mousedown", (e) => {
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          updateSelection(startX, startY, startX, startY);
        });

        window.addEventListener("mousemove", (e) => {
          if (!isDragging) return;
          updateSelection(startX, startY, e.clientX, e.clientY);
        });

        window.addEventListener("mouseup", (e) => {
          if (!isDragging) return;
          isDragging = false;
          finishSelection(startX, startY, e.clientX, e.clientY);
        });

        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            window.electronAPI.selectionOverlay.cancel();
          }
        });

        // Ensure selection element is hidden if user right-clicks or something odd
        window.addEventListener("blur", () => {
          if (!isDragging) return;
          isDragging = false;
          selectionEl.style.display = "none";
        });
      }
    </script>
  </body>
</html>
