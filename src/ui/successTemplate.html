<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Signed In</title>
  </head>
  <body style="font-family: system-ui; margin: 2rem">
    <h1>Authentication Successful</h1>
    <p>You can return to the application and close this window.</p>
    <p>
        <a id="deeplink" href="yakshaver-desktop://auth">Open App</a>
    </p>
    <script>
      (() => {
        let triggered = false;
        const link = document.getElementById('deeplink');
        const triggerDeeplink = () => {
          if (triggered) {
            return; // Prevent multiple triggers
          }
          triggered = true;
          
          try {
            link.click();
            setTimeout(() => {
              window.close();
            }, 2000);
          } catch (err) {
            console.error('Failed to open app:', err);
          }
        };
        
        // Automatically trigger on page load (only once)
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', triggerDeeplink, { once: true });
        } else {
          // DOM already loaded, trigger immediately
          triggerDeeplink();
        }
        
        // Handle manual clicks as fallback (only if auto-trigger failed)
        link.addEventListener('click', (e) => {
          if (!triggered) {
            e.preventDefault();
            triggerDeeplink();
          }
        });
      })();
    </script>
  </body>
  </html>
