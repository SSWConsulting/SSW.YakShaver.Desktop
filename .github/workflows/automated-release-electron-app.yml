name: Automated Electron App Release

on:
  push:
    branches:
      - test/release-trigger

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: 20

jobs:
  auto-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: test/release-trigger
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get version from package.json
        id: get_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current package version: $CURRENT_VERSION"

          # Bump version with logic
          # patch < 9: bump patch
          # patch = 9: bump minor, reset patch to 0
          # minor = 9 and patch = 9: bump major, reset to 0.0
          NEW_VERSION=$(node -e "
            const [major, minor, patch] = '$CURRENT_VERSION'.split('.').map(Number);
            let newMajor = major, newMinor = minor, newPatch = patch;

            if (patch < 9) {
              newPatch = patch + 1;
            } else if (minor < 9) {
              newMinor = minor + 1;
              newPatch = 0;
            } else {
              newMajor = major + 1;
              newMinor = 0;
              newPatch = 0;
            }

            console.log(\`\${newMajor}.\${newMinor}.\${newPatch}\`);
          ")

          echo "New version: $NEW_VERSION"
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=v${NEW_VERSION}" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          npm version $VERSION --no-git-tag-version
          echo "Updated package.json to version $VERSION"

      - name: Commit version update
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          git add package.json package-lock.json
          git commit -m "chore: bump version to v$VERSION [skip ci]"
          git push origin test/release-trigger
          echo "Committed and pushed version update to main"

      - name: Create and publish GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.tag_name }}"
          VERSION="${{ steps.get_version.outputs.version }}"

          gh release create "$TAG_NAME" \
            --title "v$VERSION" \
            --generate-notes \
            --target test/release-trigger \
            --draft=false

          echo "Release created and published"

      - name: Extract PR number from commit
        id: pr_number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract PR number from squash merge format: "title (#123)"
          PR_NUMBER=$(git log -1 --pretty=%B | head -1 | grep -oE '\(#[0-9]+\)' | grep -oE '[0-9]+' || echo "")

          # Fallback: use GitHub API to find PR by commit SHA
          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER=$(gh pr list --search "${{ github.sha }}" --state merged --json number --jq '.[0].number' 2>/dev/null || echo "")
          fi

          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "Found PR number: ${PR_NUMBER}"

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.pr_number.outputs.pr_number }}
          body: |
            âœ… **Automated Release Created Successfully**

            **Release Details:**
            - **Version:** ${{ steps.get_version.outputs.version }}
            - **Tag:** ${{ steps.get_version.outputs.tag_name }}
            - **Release:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag_name }}

            You can monitor the build progress in the [Actions tab](https://github.com/${{ github.repository }}/actions/workflows/automated-release-electron-app.yml).

  # Trigger the release build workflow directly (bypasses GITHUB_TOKEN limitation)
  trigger-build:
    needs: auto-release
    uses: ./.github/workflows/release-electron-app.yml
    with:
      tag_name: ${{ needs.auto-release.outputs.tag_name }}
      target: test/release-trigger
    secrets: inherit
